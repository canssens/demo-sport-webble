<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Web Bluetooth</title>
    <script>
      // Add a global error event listener early on in the page load, to help ensure that browsers
      // which don't support specific functionality still end up displaying a meaningful message.
      window.addEventListener('error', function(error) {
        if (ChromeSamples && ChromeSamples.setStatus) {
          console.error(error);
          ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
          error.preventDefault();
        }
      });
    </script>
        
    
  </head>

  <body>
    
    <h1>Web Bluetooth / Get Characteristics Sample</h1>
    
<script>
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

<script>
  window.addEventListener('DOMContentLoaded', function() {
    const searchParams = new URL(location).searchParams;
    const inputs = Array.from(document.querySelectorAll('input[id]'));

    inputs.forEach(input => {
      if (searchParams.has(input.id)) {
        if (input.type == 'checkbox') {
          input.checked = searchParams.get(input.id);
        } else {
          input.value = searchParams.get(input.id);
          input.blur();
        }
      }
      if (input.type == 'checkbox') {
        input.addEventListener('change', function(event) {
          const newSearchParams = new URL(location).searchParams;
          if (event.target.checked) {
            newSearchParams.set(input.id, event.target.checked);
          } else {
            newSearchParams.delete(input.id);
          }
          history.replaceState({}, '', Array.from(newSearchParams).length ?
              location.pathname + '?' + newSearchParams : location.pathname);
        });
      } else {
        input.addEventListener('input', function(event) {
          const newSearchParams = new URL(location).searchParams;
          if (event.target.value) {
            newSearchParams.set(input.id, event.target.value);
          } else {
            newSearchParams.delete(input.id);
          }
          history.replaceState({}, '', Array.from(newSearchParams).length ?
              location.pathname + '?' + newSearchParams : location.pathname);
        });
      }
    });
  });
</script>


<p>This sample illustrates the use of the Web Bluetooth API to get all
characteristics of an advertised service from a nearby Bluetooth Low Energy
Device. You may want to try this demo with the BLE Peripheral Simulator App
from the <a target="_blank"
href="https://play.google.com/store/apps/details?id=io.github.webbluetoothcg.bletestperipheral">Google
Play Store</a> and check out the <a href="get-characteristics-async-await.html">Get
Characteristics (Async Await)</a> sample.</p>

<form>
  <input id="service" type="text" list="services" autofocus placeholder="Bluetooth Service">
  <input id="characteristic" type="text" list="characteristics" placeholder="Optional Bluetooth Characteristic">
  <button>Get characteristics</button>
</form>

<datalist id="services">
  <option value="battery_service">battery_service</option>
  <option value="device_information">device_information</option>
  <option value="health_thermometer">health_thermometer</option>
  <option value="heart_rate">heart_rate</option>
  <option value="running_speed_and_cadence">running_speed_and_cadence</option>
  <option value="0x1826">ftms</option>

  


  
</datalist>

<datalist id="characteristics">
  <option value="aerobic_heart_rate_lower_limit">aerobic_heart_rate_lower_limit</option>
  <option value="aerobic_heart_rate_upper_limit">aerobic_heart_rate_upper_limit</option>
  <option value="battery_level">battery_level</option>
  
  <option value="gap.device_name">gap.device_name</option>
  <option value="firmware_revision_string">firmware_revision_string</option>
  
  <option value="hardware_revision_string">hardware_revision_string</option>
  <option value="heart_rate_control_point">heart_rate_control_point</option>
  <option value="heart_rate_max">heart_rate_max</option>
  <option value="heart_rate_measurement">heart_rate_measurement</option>
  <option value="heat_index">heat_index</option>
  
  <option value="manufacturer_name_string">manufacturer_name_string</option>
  
  <option value="model_number_string">model_number_string</option>
  
  <option value="serial_number_string">serial_number_string (blocklisted)</option>
  
  <option value="temperature">temperature</option>
  <option value="temperature_measurement">temperature_measurement</option>
  <option value="temperature_type">temperature_type</option>
  <option value="0x2ada">fitness_machine_status</option>
  <option value="0x2acc">ftms</option>
  <option value="0x2acd">treadmill</option>
  
</datalist>









  
    
<script>
    function onButtonClick() {
  let serviceUuid = document.querySelector('#service').value;
  if (serviceUuid.startsWith('0x')) {
    serviceUuid = parseInt(serviceUuid);
  }

  let characteristicUuid = document.querySelector('#characteristic').value;
  if (characteristicUuid.startsWith('0x')) {
    characteristicUuid = parseInt(characteristicUuid);
  }

  log('Requesting Bluetooth Device...');
  navigator.bluetooth.requestDevice({filters: [{services: [serviceUuid]}]})
  .then(device => {
    log('Connecting to GATT Server...');
    return device.gatt.connect();
  })
  .then(server => {
    log('Getting Service...');
    return server.getPrimaryService(serviceUuid);
  })
  .then(service => {
    log('Getting Characteristics...');
    if (characteristicUuid) {
      // Get all characteristics that match this UUID.
      return service.getCharacteristics(characteristicUuid);
    }
    // Get all characteristics.
    return service.getCharacteristics();
  })
  .then(characteristics => {
    log('> Characteristics: ' +
      characteristics.map(c => c.uuid).join('\n' + ' '.repeat(19)));
  })
  .catch(error => {
    log('Argh! ' + error);
  });
}
</script>


    
  

  
   
  



<script>
  document.querySelector('form').addEventListener('submit', function(event) {
    event.stopPropagation();
    event.preventDefault();

    if (isWebBluetoothEnabled()) {
      ChromeSamples.clearLog();
      onButtonClick();
    }
  });
</script>




<hr />

<h1>Heart Rate</h1>
<button id="readHeartRateMeasure">Read Bluetooth Device's Heart Rate</button>
<button id="startNotifications" disabled>Start Notifications</button>
<button id="stopNotifications" disabled>Stop Notifications</button>
<button id="reset">Reset Bluetooth Device</button>


<hr />

<h1>FTMS Treadmill</h1>
<button id="readFTMS">Read Bluetooth Device's Heart Rate</button>
<button id="startNotificationsFTMS" disabled>Start Notifications</button>
<button id="stopNotificationsFTMS" disabled>Stop Notifications</button>
<button id="resetFTMS">Reset Bluetooth Device</button>


<script>
    var ChromeSamples = {
      log: function() {
        var line = Array.prototype.slice.call(arguments).map(function(argument) {
          return typeof argument === 'string' ? argument : JSON.stringify(argument);
        }).join(' ');
  
        document.querySelector('#log').textContent += line + '\n';
      },
  
      clearLog: function() {
        document.querySelector('#log').textContent = '';
      },
  
      setStatus: function(status) {
        document.querySelector('#status').textContent = status;
      },
  
      setContent: function(newContent) {
        var content = document.querySelector('#content');
        while(content.hasChildNodes()) {
          content.removeChild(content.lastChild);
        }
        content.appendChild(newContent);
      }
    };
  </script>
  
  <h1>Live Output</h1>
  <div id="output" class="output">
    <div id="content"></div>
    <div id="status"></div>
    <pre id="log"></pre>
  </div>

  <script>
    var bluetoothDevice;
    var HeartRateMeasureCharacteristic;
    var FTMSCharacteristic;
    
    async function onReadHeartRateMeasureButtonClick() {
      try {
        if (!bluetoothDevice) {
          await requestDevice();
        }
        await connectDeviceAndCacheCharacteristics();
    
        log('Reading HR...');
        await HeartRateMeasureCharacteristic.readValue();
      } catch(error) {
        log('Argh! ' + error);
      }
    }
    
    async function requestDevice() {
      log('Requesting any Bluetooth Device...');
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters:[{
            services: ['heart_rate'],
        }],
          //acceptAllDevices: true,
          optionalServices: ['heart_rate']});

        log('> Name:             ' + bluetoothDevice.name);
        log('> Id:               ' + bluetoothDevice.id);
        log('> Connected:        ' + bluetoothDevice.gatt.connected);
      bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
    }
    
    async function connectDeviceAndCacheCharacteristics() {
      if (bluetoothDevice.gatt.connected && HeartRateMeasureCharacteristic) {
        return;
      }
    
      log('Connecting to GATT Server...');
      const server = await bluetoothDevice.gatt.connect();
    
      log('Getting heart_rate Service...');
      const service = await server.getPrimaryService('heart_rate');
    
      log('Getting heart_rate_measurement Level Characteristic...');
      HeartRateMeasureCharacteristic = await service.getCharacteristic('heart_rate_measurement');
    
      HeartRateMeasureCharacteristic.addEventListener('characteristicvaluechanged',
          handleHeartRateMeasureChanged);
      document.querySelector('#startNotifications').disabled = false;
      document.querySelector('#stopNotifications').disabled = true;
    }
    
    /* This function will be called when `readValue` resolves and
     * characteristic value changes since `characteristicvaluechanged` event
     * listener has been added. */
    function handleHeartRateMeasureChanged(event) {
      let HeartRateMeasure = event.target.value.getUint8(1);
      log('> HR Level is ' + HeartRateMeasure + '%');
    }
    
    async function onStartNotificationsButtonClick() {
      try {
        log('Starting HR Notifications...');
        await HeartRateMeasureCharacteristic.startNotifications();
    
        log('> Notifications started');
        document.querySelector('#startNotifications').disabled = true;
        document.querySelector('#stopNotifications').disabled = false;
      } catch(error) {
        log('Argh! ' + error);
      }
    }
    
    async function onStopNotificationsButtonClick() {
      try {
        log('Stopping HR Notifications...');
        await HeartRateMeasureCharacteristic.stopNotifications();
    
        log('> Notifications stopped');
        document.querySelector('#startNotifications').disabled = false;
        document.querySelector('#stopNotifications').disabled = true;
      } catch(error) {
        log('Argh! ' + error);
      }
    }
    
    function onResetButtonClick() {
      if (HeartRateMeasureCharacteristic) {
        HeartRateMeasureCharacteristic.removeEventListener('characteristicvaluechanged',
            handleHeartRateMeasureChanged);
        HeartRateMeasureCharacteristic = null;
      }
      // Note that it doesn't disconnect device.
      bluetoothDevice = null;
      log('> Bluetooth Device reset');
    }
    
    async function onDisconnected() {
      log('> Bluetooth Device disconnected');
      try {
        await connectDeviceAndCacheCharacteristics()
      } catch(error) {
        log('Argh! ' + error);
      }
    }

    //FTMS 
    async function onReadFTMSButtonClick() {
      try {
        if (!bluetoothDevice) {
          await requestDeviceFTMS();
        }
        await connectDeviceAndCacheCharacteristicsFTMS();
    
        log('Reading FTMS...');
        await FTMSCharacteristic.readValue();
      } catch(error) {
        log('Argh!1 ' + error);
      }
    }
    
    async function requestDeviceFTMS() {
      log('Requesting any Bluetooth Device...');
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters:[{
            services: [parseInt('0x1826')],
        }],
          //acceptAllDevices: true,
          optionalServices: ['heart_rate']});

        log('> Name:             ' + bluetoothDevice.name);
        log('> Id:               ' + bluetoothDevice.id);
        log('> Connected:        ' + bluetoothDevice.gatt.connected);
      bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
    }
    
    async function connectDeviceAndCacheCharacteristicsFTMS() {
      if (bluetoothDevice.gatt.connected && FTMSCharacteristic) {
        return;
      }
    
      log('Connecting to GATT Server...');
      const server = await bluetoothDevice.gatt.connect();
    
      log('Getting ftms Service...');
      const service = await server.getPrimaryService(parseInt('0x1826'));
    
      log('Getting ftms treadmill Characteristic...');
      FTMSCharacteristic = await service.getCharacteristic(parseInt('0x2acd'));//
      
      await FTMSCharacteristic.startNotifications();

        log('> Notifications started');
        FTMSCharacteristic.addEventListener('characteristicvaluechanged',
            handleNotifications);
      
    
      document.querySelector('#startNotifications').disabled = false;
      document.querySelector('#stopNotifications').disabled = true;
    }

    function handleNotifications(event) {
        let value = event.target.value;
        let a = [];
        // Convert raw data bytes to hex values just for the sake of showing something.
        // In the "real" world, you'd use data.getUint8, data.getUint16 or even
        // TextDecoder to process raw data bytes.
        for (let i = 0; i < value.byteLength; i++) {
            a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
        }
        log('> ' + a.join(' '));
        log('> ' + (value.getUint16(2, /*littleEndian=*/true)/100));
        }
    
    /* This function will be called when `readValue` resolves and
     * characteristic value changes since `characteristicvaluechanged` event
     * listener has been added. */
    function handleFTMSChanged(event) {
      let FTMSMeasure = event.target.value.getUint8(1);
      log('> FTMS Level is ' + FTMSMeasure + '%');
    }
    
    async function onStartNotificationsFTMSButtonClick() {
      try {
        log('Starting FTMS Notifications...');
        await FTMSCharacteristic.startNotifications();
    
        log('> Notifications started');
        document.querySelector('#startNotifications').disabled = true;
        document.querySelector('#stopNotifications').disabled = false;
      } catch(error) {
        log('Argh! ' + error);
      }
    }
    
    async function onStopNotificationsFTMSButtonClick() {
      try {
        log('Stopping FTMS Notifications...');
        await FTMSCharacteristic.stopNotifications();
    
        log('> Notifications stopped');
        document.querySelector('#startNotifications').disabled = false;
        document.querySelector('#stopNotifications').disabled = true;
      } catch(error) {
        log('Argh! ' + error);
      }
    }
    
    function onResetFTMSButtonClick() {
      if (FTMSCharacteristic) {
        FTMSCharacteristic.removeEventListener('characteristicFTMSvaluechanged',
            handleFTMSChanged);
            FTMSCharacteristic = null;
      }
      // Note that it doesn't disconnect device.
      bluetoothDevice = null;
      log('> Bluetooth Device reset');
    }
    
    async function onDisconnected() {
      log('> Bluetooth Device disconnected');
      try {
        await connectDeviceAndCacheCharacteristicsFTMS()
      } catch(error) {
        log('Argh! ' + error);
      }
    }


    </script>



<script>
    document.querySelector('#readHeartRateMeasure').addEventListener('click', function() {
      if (isWebBluetoothEnabled()) {
        onReadHeartRateMeasureButtonClick();
      }
    });
  
    document.querySelector('#startNotifications').addEventListener('click', function(event) {
      if (isWebBluetoothEnabled()) {
        onStartNotificationsButtonClick();
      }
    });
  
    document.querySelector('#stopNotifications').addEventListener('click', function(event) {
      if (isWebBluetoothEnabled()) {
        onStopNotificationsButtonClick();
      }
    });
  
    document.querySelector('#reset').addEventListener('click', function(event) {
      if (isWebBluetoothEnabled()) {
        ChromeSamples.clearLog();
        onResetButtonClick();
      }
    });

    //FTMS
    document.querySelector('#readFTMS').addEventListener('click', function() {
      if (isWebBluetoothEnabled()) {
        onReadFTMSButtonClick();
      }
    });
  
    document.querySelector('#startNotificationsFTMS').addEventListener('click', function(event) {
      if (isWebBluetoothEnabled()) {
        onStartNotificationsFTMSButtonClick();
      }
    });
  
    document.querySelector('#stopNotificationsFTMS').addEventListener('click', function(event) {
      if (isWebBluetoothEnabled()) {
        onStopNotificationsFTMSButtonClick();
      }
    });
  
    document.querySelector('#resetFTMS').addEventListener('click', function(event) {
      if (isWebBluetoothEnabled()) {
        ChromeSamples.clearLog();
        onResetFTMSButtonClick();
      }
    });


  </script>
  





  <script>
    log = ChromeSamples.log;
  
    function isWebBluetoothEnabled() {
      if (navigator.bluetooth) {
        return true;
      } else {
        ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
            'Please make sure the "Experimental Web Platform features" flag is enabled.');
        return false;
      }
    }
  </script>

    

  </body>
</html>
